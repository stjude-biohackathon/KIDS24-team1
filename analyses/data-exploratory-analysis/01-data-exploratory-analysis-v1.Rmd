---
title: "Data exploratory analysis"
author: "Antonia Chroni <achroni@stjude.org> for St. Jude Children's Research Hospital BioHackathon Team 1"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_folding: hide
    toc_depth: 6
    highlight: tango
    number_sections: TRUE
  pdf_document:
    toc: TRUE
    highlight: tango
    number_sections: TRUE
    latex_engine: lualatex
    keep_tex: FALSE
always_allow_html: TRUE
urlcolor: blue
linkcolor: black
citecolor: blue
geometry: margin=1in
header-includes: 
  - \usepackage{titling}
  - \usepackage{fancyhdr}
params:
  root_dir: './'
  PROJECT_NAME: './'
  LEAD_ANALYSTS: './'
  CONTACT_EMAIL: './'
  START_DATE: './'
  COMPLETION_DATE: './'
  input_file: './'
---

```{r logo-file, echo=FALSE}
attach(params)
# Insert logo on the top of the html report 
logo_file <- file.path(root_dir, "img", "chromic-logo.png")
htmltools::img(src = knitr::image_uri(logo_file), alt = "logo", style = "position:absolute; top:0; left:0; padding:0px; height:120px;")
detach(params)
```

\addtolength{\headheight}{2.0cm} 
\fancypagestyle{plain}{} 
\thispagestyle{fancy}
\fancyhead[L]{\includegraphics[height=120px]{`r logo_file`}}
\renewcommand{\headrulewidth}{0pt}

<style type="text/css">
:root { --chromic_color: #17818F;}

h1.title {margin-top: 130px;
  margin-bottom: 25px;
  font-size: 36px;}

.nobullet li {list-style-type: none;}

.reporthead {font-size: 20px;}

body { /* Normal */
  font-size: 16px;
  font-style: Arial, Helvetica, sans-serif;}

h1 {
  color: var(--chromic_color);
  font-size: 28px;
  margin-top: 50px;}

h2 {color: var(--chromic_color);
  font-size: 20px;}

.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
  background-color: var(--chromic_color);}
</style>

<a href="https://wiki.stjude.org/display/CAB">

</a>

\pagebreak

<div class="reporthead"><br/>
**Project: `r params$PROJECT_NAME`**  

<br />  

**St. Jude Children's Research Hospital BioHackathon Team 1**
<br />  


>Date started: `r params$START_DATE`
<br />
>Date completed:  `r params$COMPLETION_DATE`
<br />
>Report generated: `r format(Sys.time(), '%H:%M:%S %Z %m/%d/%Y')` \

</div>
\pagebreak

# Information about this notebook
This is an exploratory analysis of the data availability in terms of assays in the Comprehensive Omics Catalogue for Hartwell. This is critical for mitigating duplicate sequencing requests and efforts through Hartwell. This notebook aims to showcase:
(1) which samples have already been sequenced by Hartwell, and 
(2) what omics data are available per sample.

For demo purposes, we use dummy data and subset by human brain tumor samples. We investigate the number of samples per `cancer_type_brain` and `Assay`.

# Set up

```{r load-library, echo=TRUE}
suppressPackageStartupMessages({
  library(tidyverse)
})
```

# Directories and paths to file Inputs/Outputs

```{r set-dir-and-file-names, echo=TRUE}
attach(params)
analysis_dir <- file.path(root_dir, "analyses", "data-exploratory-analysis") 

# We will first read in metadata file as we need to define sample_name 
metadata_file <- file.path(analysis_dir, "input", input_file) # metadata input file

# File path to `results` directory
results_dir <- file.path(analysis_dir, "results") 
if (!dir.exists(results_dir)) {
  dir.create(results_dir)}

source(paste0(analysis_dir, "/util/generate-fake-SJUID.R"))
```

# Read metadata file

We will subset by human brain tumor samples.

```{r read-process-metadata, echo=TRUE}
# Read metadata
project_df <- read.csv(metadata_file, stringsAsFactors=FALSE) %>%
  
  # Add cancer_type_brain: Ependymoma, HGG, LGG, Medulloblastoma
  add_column(cancer_type_brain = "other") %>%
  mutate(cancer_type_brain = case_when(grepl("Ependymoma", Disease) ~ "Ependymoma",
                                     grepl("HGG", Disease) ~ "HGG",
                                     grepl("LGG", Disease) ~ "LGG",
                                     grepl("MedulloBlastoma", Disease) ~ "Medulloblastoma"),
         Assay = Omics.Method) %>%
  mutate(across(where(is.character), ~ na_if(.,""))) %>% # Omics Method for NA
  filter(!cancer_type_brain == "other",
         !is.na(cancer_type_brain),
         !is.na(Omics.Method),
         Source == "Human") %>% 
  select(Source, Disease, Assay, Omics.Method.Detail, Site, Sub.Group, cancer_type_brain) 
```

## Generate fake SJUID

We will generate random SJUID per brain cancer type as this information is not contained in the current data.

```{r generate-fake-SJUID, echo=TRUE}
# Create a smaller set of unique strings, each starting with "SJH"
unique_strings <- paste0("SJH", sapply(1:80, function(x) generate_string(8)))

# Sample from this set to create a vector of 100 strings, allowing duplicates
SJUID <- sample(unique_strings, 100, replace = TRUE)

# Generate vector for `cancer_type_brain`
cancer_type_brain_vec <- c("Ependymoma", "HGG", "LGG", "Medulloblastoma")
n <- 25 # random number
cancer_type_brain <- rep(cancer_type_brain_vec, each=n)

# Assign `SJUID` to `cancer_type_brain`
bind_df <- cbind(SJUID, cancer_type_brain)  %>% 
  as.data.frame()

# Merge both df
df <- project_df %>% 
  left_join(bind_df, by = "cancer_type_brain", relationship = "many-to-many") %>% 
  unique() %>% 
  mutate(match_id = paste(SJUID, Assay, sep = "_")) %>%
  distinct(match_id, .keep_all = TRUE) %>%
  write_tsv(file.path(results_dir, "cohort.tsv")) # save 


# Number of samples per cancer_type_brain
assays_number <- length(df$SJUID)
samples_number <- length(unique(df$SJUID))
```

```{r re-order-df, echo=TRUE}
cancer_type_brain_order <- c("Ependymoma", "HGG", "LGG", "Medulloblastoma")

# Re-order df
f <- c("WES", "WGBS", "WGS", "RNAseq", "ATACseq", "ChIPseq", "Methylation")# Level df by assay
df <- df %>% 
  dplyr:::mutate(Assay = factor(Assay),
                 Assay = fct_relevel(Assay, f)) %>%
  arrange(cancer_type_brain, Assay) 
```

# Number of samples with assay information

```{r, fig.align = "left", results = "asis", message = FALSE, warning = FALSE, echo = FALSE}
tables1 <- df %>% count(Assay)
cat("  \n<div style=\"font-size:80%\">  \n")
print(knitr::kable(tables1, align = "lcccc", caption = "Summary of samples per assay"))
cat("  \n</div>  \n")
cat("  \n\\pagebreak  \n")
```

# Number of samples per brain cancer type and assay

## Overall assays

There are `r samples_number` brain tumor samples with `r assays_number` assays in total.

```{r, fig.align = "left", results = "asis", message = FALSE, warning = FALSE, echo = FALSE}
tables1 <- df %>% count(cancer_type_brain)
cat("  \n<div style=\"font-size:80%\">  \n")
print(knitr::kable(tables1, align = "lcccc", caption = "Summary of samples and assays per brain cancer type"))
cat("  \n</div>  \n")
cat("  \n\\pagebreak  \n")
```

## Per assay

```{r, fig.align = "left", results = "asis", message = FALSE, warning = FALSE, echo = FALSE}
tables1 <- df %>% count(cancer_type_brain, Assay) %>%
  pivot_wider(names_from = Assay, values_from = n) %>%
  as.data.frame() %>%
  mutate_all(funs(replace_na(.,0)))

cat("  \n<div style=\"font-size:80%\">  \n")
print(knitr::kable(tables1, align = "lcccc", caption = "Summary of samples and assays per brain cancer type and per assay"))
cat("  \n</div>  \n")
cat("  \n\\pagebreak  \n")
```

# Number of samples per brain cancer type, assay, and SJUID

```{r, fig.align = "left", results = "asis", message = FALSE, warning = FALSE, echo = FALSE}
tables1 <- df %>% count(cancer_type_brain, Assay, SJUID) %>%
  pivot_wider(names_from = Assay, values_from = n) %>%
  as.data.frame() %>%
  mutate_all(funs(replace_na(.,0)))

cat("  \n<div style=\"font-size:80%\">  \n")
print(knitr::kable(tables1, align = "lcccc", caption = "Summary of samples and assays per brain cancer type, per assay and per SJUID"))
cat("  \n</div>  \n")
cat("  \n\\pagebreak  \n")
```

# Future directions

The current exploratory data analysis module can be expanded by investigating samples with paired assays. Moreover, if other metadata are available, e.g., disease_stage, treatment, this will build large, longitudinal cohorts with multi-omic sequencing data. Such an analysis permits consideration of samples according to the condition(s) of the experiment and research aims. In addition, it can be used to refine research questions and/or generate new ones.

This will facilitate collaboration across departments at St. Jude, expedite discoveries, and find cures for children with cancer and other catastrophic diseases.

```{r echo=FALSE}
detach(params)
```

\pagebreak

# Session Info

```{r echo=FALSE}
sessionInfo()
```

