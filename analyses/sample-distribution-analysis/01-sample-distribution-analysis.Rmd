---
title: "Sample distribution analysis"
author: "Antonia Chroni <achroni@stjude.org> for St. Jude Children's Research Hospital BioHackathon Team 1"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_folding: hide
    toc_depth: 6
    highlight: tango
    number_sections: TRUE
  pdf_document:
    toc: TRUE
    highlight: tango
    number_sections: TRUE
    latex_engine: lualatex
    keep_tex: FALSE
always_allow_html: TRUE
urlcolor: blue
linkcolor: black
citecolor: blue
geometry: margin=1in
header-includes: 
  - \usepackage{titling}
  - \usepackage{fancyhdr}
params:
  root_dir: './'
  PROJECT_NAME: './'
  LEAD_ANALYSTS: './'
  CONTACT_EMAIL: './'
  START_DATE: './'
  COMPLETION_DATE: './'
  input_file: './'
---

```{r logo-file, echo=FALSE}
attach(params)
# Insert logo on the top of the html report 
logo_file <- file.path(root_dir, "img", "chromic-logo.png")
htmltools::img(src = knitr::image_uri(logo_file), alt = "logo", style = "position:absolute; top:0; left:0; padding:0px; height:120px;")
detach(params)
```

\addtolength{\headheight}{2.0cm} 
\fancypagestyle{plain}{} 
\thispagestyle{fancy}
\fancyhead[L]{\includegraphics[height=120px]{`r logo_file`}}
\renewcommand{\headrulewidth}{0pt}

<style type="text/css">
:root { --chromic_color: #17818F;}

h1.title {margin-top: 130px;
  margin-bottom: 25px;
  font-size: 36px;}

.nobullet li {list-style-type: none;}

.reporthead {font-size: 20px;}

body { /* Normal */
  font-size: 16px;
  font-style: Arial, Helvetica, sans-serif;}

h1 {
  color: var(--chromic_color);
  font-size: 28px;
  margin-top: 50px;}

h2 {color: var(--chromic_color);
  font-size: 20px;}

.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
  background-color: var(--chromic_color);}
</style>

<a href="https://wiki.stjude.org/display/CAB">

</a>

\pagebreak

<div class="reporthead"><br/>
**Project: `r params$PROJECT_NAME`**  

<br />  

**St. Jude Children's Research Hospital BioHackathon Team 1**
<br />  


>Date started: `r params$START_DATE`
<br />
>Date completed:  `r params$COMPLETION_DATE`
<br />
>Report generated: `r format(Sys.time(), '%H:%M:%S %Z %m/%d/%Y')` \

</div>
\pagebreak

# Information about this notebook
This is an exploratory analysis of the data availability in terms of assays in the Comprehensive Omics Catalogue for Hartwell. This is critical for mitigating duplicate sequencing requests and efforts through Hartwell. This notebook aims to showcase:
(1) what data have already been sequenced by Hartwell and 
(2) what omics data are available per sample.

For demo purposes, we subset by human brain tumor samples. We investigate the number of samples per `cancer_type_brain` and `Assay`.

# Set up

```{r load-library, echo=TRUE}
suppressPackageStartupMessages({
  library(tidyverse)
  library(flextable)
})
```

# Directories and paths to file Inputs/Outputs

```{r set-dir-and-file-names, echo=TRUE}
attach(params)
analysis_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis") 

# We will first read in metadata file as we need to define sample_name 
metadata_file <- file.path(analysis_dir, "input", input_file) # metadata input file

# File path to `results` directory
results_dir <- file.path(analysis_dir, "results") 
if (!dir.exists(results_dir)) {
  dir.create(results_dir)}
```

# Read metadata file

We will subset by human brain tumor samples.

```{r read-process-metadata, echo=TRUE}
# Read metadata
project_df <- read.csv(metadata_file, stringsAsFactors=FALSE) %>%
  
  # Add cancer_type_brain: Ependymoma, HGG, LGG, Medulloblastoma
  add_column(cancer_type_brain = "other") %>%
  mutate(cancer_type_brain = case_when(grepl("Ependymoma", Disease) ~ "Ependymoma",
                                     grepl("HGG", Disease) ~ "HGG",
                                     grepl("LGG", Disease) ~ "LGG",
                                     grepl("MedulloBlastoma", Disease) ~ "Medulloblastoma"),
         Assay = Omics.Method) %>%
  mutate(across(where(is.character), ~ na_if(.,""))) %>% # Omics Method for NA
  filter(!cancer_type_brain == "other",
         !is.na(cancer_type_brain),
         !is.na(Omics.Method),
         Source == "Human") %>% 
  select(Source, Disease, Assay, Omics.Method.Detail, Site, Sub.Group, cancer_type_brain) 
```

## Generate SJUID

We will generate random SJUID per brain cancer type as this information is not contained in the current data.

```{r generate-SJUID, echo=TRUE}
# Make this reproducible
set.seed(2024) 

# create vector of data$Sample.SJUID with some duplicates
generate_string <- function(length) {
  chars <- c(LETTERS, LETTERS, 0:9)
  paste0(sample(chars, length, replace = TRUE), collapse = "")
}

# Create a smaller set of unique strings, each starting with "SJH"
unique_strings <- paste0("SJH", sapply(1:80, function(x) generate_string(8)))

# Sample from this set to create a vector of 100 strings, allowing duplicates
SJUID <- sample(unique_strings, 100, replace = TRUE)

# Generate vector for `cancer_type_brain`
cancer_type_brain_vec <- c("Ependymoma", "HGG", "LGG", "Medulloblastoma")
n <- 25 # random number
cancer_type_brain <- rep(cancer_type_brain_vec, each=n)

# Assign `SJUID` to `cancer_type_brain`
bind_df <- cbind(SJUID, cancer_type_brain)  %>% 
  as.data.frame()

# Merge both df
df <- project_df %>% 
  left_join(bind_df, by = "cancer_type_brain", relationship = "many-to-many") %>% 
  unique() %>% 
  mutate(match_id = paste(SJUID, Assay, sep = "_")) %>%
  distinct(match_id, .keep_all = TRUE) %>%
  write_tsv(file.path(results_dir, "cohort.tsv")) # save 


# Number of samples per cancer_type_brain
assays_number <- length(df$SJUID)
samples_number <- length(unique(df$SJUID))
```

## Number of samples with assay information

There are `r samples_number` brain tumor samples with `r assays_number` assays in total.

## Number of assays per brain cancer type

```{r, fig.align = "left", results = "asis", message = FALSE, warning = FALSE, echo = FALSE}
tables1 <- df %>% count(cancer_type_brain)
cat("  \n<div style=\"font-size:80%\">  \n")
print(knitr::kable(tables1, align = "lcccc", caption = "Summary of assays per brain cancer type"))
cat("  \n</div>  \n")
cat("  \n\\pagebreak  \n")
```


# Number of samples per Assay

```{r table-1, echo=FALSE}
df %>%
  count(Assay) %>%
  arrange(desc(n)) %>% 
  regulartable() %>%
  fontsize(size = 12, part = "all")
```

# Number of samples per brain cancer type and Assay

```{r table-2, echo=FALSE}
df %>%
  count(Assay, cancer_type_brain) %>%
  pivot_wider(names_from = Assay, values_from = n) %>% 
  regulartable() %>%
  fontsize(size = 12, part = "all")
```

# Number of samples per brain cancer type, Assay, and SJUID

```{r table-3, echo=FALSE}
df %>%
  count(Assay, cancer_type_brain, SJUID) %>%
  pivot_wider(names_from = Assay, values_from = n) %>% 
  regulartable() %>%
  fontsize(size = 12, part = "all")
```

# Future directions

The current exploratory data analysis can be expanded by investigating samples with paired assays.
Moreover, if other metadata are available, e.g., disease_stage, treatment, this will lead to build large, longitudinal cohorts with multi-omic sequencing data. Such an analysis permits to consider samples according to the condition(s) of the experiment and research aims, accordingly. In addition, it can be used to refine research questions and/or generate new ones.

This will facilitate collaboration across departments at St Jude, expedite discoveries, and find cures for children with cancer and other catastrophic diseases.


```{r echo=FALSE}
detach(params)
```

\pagebreak

# Session Info

```{r echo=FALSE}
sessionInfo()
```

